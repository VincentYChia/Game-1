# COMPREHENSIVE IMPLEMENTATION PLAN
## Stat Tracking & Unlock System Integration

**Created**: 2026-01-21
**Status**: In Progress
**Goal**: Complete stat tracking system with tag-driven unlock conditions for titles and skills

---

## üìä CURRENT STATE ANALYSIS

### ‚úÖ COMPLETED (Commits: 3fe65ea, a5424fc, 7bd8f78)

#### StatTracker Foundation
- **StatTracker component** (~1,200 lines)
  - 13 major categories
  - 850-1,000 individual stat fields
  - StatEntry, CraftingEntry, SkillStatEntry classes
  - Full serialization/deserialization
  - Edge case handling (infinity, None, sets‚Üílists)

#### Integration Points (Partial)
- ‚úÖ **Gathering tracking**: Character.harvest_resource()
  - Tracks resources by type, tier, category
  - Tracks critical hits, rare drops
  - Tracks tool usage and durability
- ‚úÖ **Combat tracking**: CombatManager
  - Tracks damage dealt/taken
  - Tracks kills, weapon elements
  - Tracks status effects applied/received
- ‚úÖ **Crafting tracking**: game_engine._complete_minigame()
  - Tracks success/failure
  - Tracks quality scores, materials consumed
  - Tracks tier, discipline, rarity

#### Save/Load System
- ‚úÖ SaveManager serialization integrated
- ‚úÖ Character.restore_from_save() integrated
- ‚úÖ Backward compatible (old saves initialize fresh tracker)

#### Unlock Condition Framework
- ‚úÖ **8 condition types** created:
  - LevelCondition, StatCondition, ActivityCondition
  - StatTrackerCondition (NEW - uses comprehensive stats)
  - TitleCondition, SkillCondition, QuestCondition, ClassCondition
- ‚úÖ **ConditionFactory** for JSON parsing
- ‚úÖ **UnlockRequirements** composite class
- ‚úÖ Tag-driven, modular, LLM-extensible

#### Title System Overhaul
- ‚úÖ TitleDefinition updated to use UnlockRequirements
- ‚úÖ TitleDatabase parsing updated
- ‚úÖ TitleSystem.check_for_title() updated
- ‚úÖ All 6 call sites updated (character.py, game_engine.py)
- ‚úÖ Debug mode (F3) preserved - bypasses requirements

---

## ‚ùå INCOMPLETE WORK

### Missing StatTracker Integration Points
1. ‚ùå **Skill usage tracking** - SkillManager.activate_skill()
2. ‚ùå **Item tracking** - Inventory.add_item() / remove_item()
3. ‚ùå **Time tracking** - game loop update
4. ‚ùå **Distance tracking** - character movement

### Missing Skill Unlock System
5. ‚ùå SkillUnlock data model
6. ‚ùå SkillUnlockDatabase
7. ‚ùå SkillUnlockSystem
8. ‚ùå Integration at triggers (level up, activity, title earned)
9. ‚ùå Debug mode (F2) integration

### JSON Updates Required
10. ‚ùå **titles-1.JSON** - Update to new requirement format
11. ‚ùå **skill-unlocks.JSON** - Update to new requirement format

### Testing & Documentation
12. ‚ùå Backward compatibility testing
13. ‚ùå In-game testing (gathering, crafting, combat, titles)
14. ‚ùå Test suite creation
15. ‚ùå Documentation
16. ‚ùå Update MASTER_ISSUE_TRACKER.md (deferred enemy tracking)

---

## üéØ IMPLEMENTATION STRATEGY

### PHASE 1: Complete StatTracker Integration (CRITICAL PATH)
**Rationale**: Without complete tracking, unlock conditions won't work properly

#### 1.1 Skill Usage Tracking
**Files**: `entities/components/skill_manager.py`
**Integration Point**: `activate_skill()` method
**What to Track**:
- Skill ID
- Value delivered (damage, healing, buffs)
- Mana cost
- Targets affected
- Category (gathering/combat/crafting/utility)

**Considerations**:
- Skills already have mana costs and effects
- Need to extract actual value from effect execution
- Don't interfere with existing skill activation logic
- Record AFTER successful activation

#### 1.2 Item Tracking
**Files**: `entities/components/inventory.py`
**Integration Points**: `add_item()`, `remove_item()`, `consume_from_inventory()`
**What to Track**:
- Item collection (add_item with source context)
- Item consumption (consumables used)
- Item rarity
- First-time discoveries

**Considerations**:
- Inventory is used everywhere (gathering, crafting, combat loot)
- Need to distinguish collection sources (gathered vs crafted vs looted)
- Don't double-count items
- Handle stack additions correctly

#### 1.3 Time/Distance Tracking
**Files**: `core/game_engine.py`, `entities/character.py`
**Integration Points**: `update()` loop, `move()` method
**What to Track**:
- Playtime (delta time accumulation)
- Session time
- Distance traveled
- Distance by movement type (walking/sprinting/encumbered)
- Chunk exploration

**Considerations**:
- Delta time already available in update loop
- Character already has movement methods
- Chunk tracking needs world position context
- Don't impact performance

---

### PHASE 2: Update JSON Files (DATA PREPARATION)
**Rationale**: Fix JSONs before building skill unlock system to avoid rework

#### 2.1 Update titles-1.JSON
**Current Format** (Legacy):
```json
"prerequisites": {
  "activities": {"oresMined": 100},
  "requiredTitles": [],
  "characterLevel": 0
}
```

**New Format** (Tag-Driven):
```json
"prerequisites": {
  "conditions": [
    {"type": "activity", "activity": "mining", "min_count": 100}
  ],
  "characterLevel": 0  // Legacy support
}
```

**Strategy**:
- Keep legacy fields for backward compatibility
- Add explicit conditions array for complex requirements
- Use StatTrackerCondition for advanced requirements (criticalHits, perfectCrafts, etc.)

**Examples to Update**:
- "Apprentice Flame Miner" (fireOresMined: 200)
  - Add: `{"type": "stat_tracker", "stat_path": "gathering_totals.fire_resources_gathered", "min_value": 200}`
- "Expert Battle Sage" (criticalHits: 500, perfectDodges: 100)
  - Add: `{"type": "stat_tracker", "stat_path": "combat_actions.critical_hits", "min_value": 500}`
  - Add: `{"type": "stat_tracker", "stat_path": "combat_actions.perfect_dodges", "min_value": 100}`

#### 2.2 Update skill-unlocks.JSON
**Current Format**:
```json
"conditions": {
  "characterLevel": 3,
  "stats": {"intelligence": 8},
  "activityMilestones": [
    {"type": "craft_count", "discipline": "smithing", "count": 10}
  ]
}
```

**New Format** (Align with title format):
```json
"conditions": {
  "conditions": [
    {"type": "level", "min_level": 3},
    {"type": "stat", "requirements": {"intelligence": 8}},
    {"type": "stat_tracker", "stat_path": "crafting_by_discipline.smithing.total_crafts", "min_value": 10}
  ]
}
```

**Strategy**:
- Transform activityMilestones into StatTrackerConditions
- Use same ConditionFactory parsing logic as titles
- Ensure all unlock methods (automatic, quest_reward, milestone_unlock, title_unlock, npc_purchase) work

---

### PHASE 3: Skill Unlock System (CORE FEATURE)
**Rationale**: Complete the unlock system architecture

#### 3.1 Create SkillUnlock Model
**File**: `data/models/skill_unlocks.py`
**Design**:
```python
@dataclass
class SkillUnlock:
    unlock_id: str
    skill_id: str
    unlock_method: str  # automatic, quest_reward, milestone_unlock, title_unlock, npc_purchase
    requirements: UnlockRequirements
    trigger_type: str  # level_up, activity_threshold, title_earned, quest_complete, npc_interaction
    trigger_value: Any
    message: str
    cost_gold: int = 0
    cost_materials: Dict[str, int] = field(default_factory=dict)
```

**Considerations**:
- Reuse UnlockRequirements from title system
- Support all unlock methods from JSON
- Track unlock state separately from skill learned state

#### 3.2 Create SkillUnlockDatabase
**File**: `data/databases/skill_unlock_db.py`
**Design**:
```python
class SkillUnlockDatabase:
    _instance = None
    unlocks: Dict[str, SkillUnlock] = {}

    def load_from_file(filepath: str)
    def get_unlocks_for_trigger(trigger_type: str) -> List[SkillUnlock]
    def get_unlock_for_skill(skill_id: str) -> Optional[SkillUnlock]
```

**Considerations**:
- Singleton pattern (like TitleDatabase)
- Use ConditionFactory for parsing
- Index by trigger type for efficient checking

#### 3.3 Create SkillUnlockSystem
**File**: `systems/skill_unlock_system.py`
**Design**:
```python
class SkillUnlockSystem:
    unlocked_skills: Set[str]  # Skills available but not yet learned

    def check_for_unlocks(character, trigger_type, trigger_value) -> List[SkillUnlock]
    def is_skill_unlocked(skill_id: str) -> bool
    def unlock_skill(skill_id: str)
```

**Considerations**:
- Track "unlocked but not learned" state
- Check on appropriate triggers
- Don't auto-learn skills (just make available)
- Integrate with SkillManager

#### 3.4 Integration Points
**Triggers to Add**:
1. **Level Up**: `leveling.add_exp()` ‚Üí check "level_up" triggers
2. **Activity Threshold**: After recording activity ‚Üí check "activity_threshold" triggers
3. **Title Earned**: After earning title ‚Üí check "title_earned" triggers
4. **Quest Complete**: `quest_system.complete_quest()` ‚Üí check "quest_complete" triggers

**SkillManager Integration**:
- Update `can_learn_skill()` to check unlock status
- Update `learn_skill()` to verify unlock
- Preserve `skip_checks` for debug mode (F2)

**Notification System**:
- Show notification when skill becomes available
- Show notification when skill is learned
- Different messages for auto-unlocks vs manual unlocks

---

### PHASE 4: Testing & Documentation
**Rationale**: Ensure quality and provide guidance

#### 4.1 Backward Compatibility Testing
**Test Cases**:
- Load save from before stat tracking ‚Üí should initialize fresh tracker
- Load save with partial tracking ‚Üí should preserve data
- Load save with full tracking ‚Üí should restore completely
- Verify no crashes, no data loss

#### 4.2 In-Game Testing Checklist
**Gathering**:
- [ ] Mine 100 iron ore ‚Üí verify resources_gathered, total_ores_mined
- [ ] Chop 100 trees ‚Üí verify resources_gathered, total_trees_chopped
- [ ] Critical gather ‚Üí verify total_critical_gathers increments
- [ ] Earn "Novice Miner" title at 100 ores

**Crafting**:
- [ ] Craft 10 iron swords ‚Üí verify crafting_by_discipline.smithing.total_crafts
- [ ] Craft with perfect score ‚Üí verify perfect_crafts increments
- [ ] Craft legendary item ‚Üí verify legendary_items_crafted
- [ ] Earn "Novice Smith" title at 50 crafts

**Combat**:
- [ ] Deal damage ‚Üí verify combat_damage.total_damage_dealt
- [ ] Kill enemy ‚Üí verify combat_kills.total_enemies_defeated
- [ ] Critical hit ‚Üí verify combat_actions.critical_hits
- [ ] Earn "Novice Warrior" title at 50 kills

**Skills**:
- [ ] Use skill ‚Üí verify skills_used[skill_id].times_used
- [ ] Reach level 3 with 10 smithing crafts ‚Üí unlock "Smith's Focus"
- [ ] Earn title ‚Üí unlock title-locked skill
- [ ] Debug F2 ‚Üí bypasses unlock requirements

**Save/Load**:
- [ ] Save with stats ‚Üí load ‚Üí verify all stats preserved
- [ ] Session count increments correctly
- [ ] Playtime accumulates correctly

#### 4.3 Test Suite Creation
**File**: `tests/test_stat_tracker.py`
**Coverage**:
- StatEntry recording and aggregation
- CraftingEntry success/failure tracking
- SkillStatEntry value tracking
- Serialization/deserialization
- StatTrackerCondition evaluation
- ConditionFactory parsing

**File**: `tests/test_unlock_conditions.py`
**Coverage**:
- Each condition type evaluation
- UnlockRequirements composite logic
- ConditionFactory JSON parsing
- Legacy format compatibility

#### 4.4 Documentation
**File**: `docs/STAT_TRACKING_SYSTEM.md`
**Contents**:
- System architecture overview
- Stat categories and fields
- How to add new tracked stats
- Integration points for new features

**File**: `docs/UNLOCK_SYSTEM_FOR_LLM.md`
**Contents**:
- How to add new titles (JSON examples)
- How to add new skill unlocks (JSON examples)
- Condition type reference
- Tag-driven design philosophy

#### 4.5 Issue Tracker Update
**File**: `MASTER_ISSUE_TRACKER.md`
**Add Section**:
```markdown
## DEFERRED FEATURES

### Detailed Enemy Stat Tracking
**Status**: Deferred
**Reason**: Not needed for current title/skill unlock requirements

**Scope**:
- Per-enemy-type kill tracking (goblin: 50, dragon: 1)
- Damage dealt/taken per enemy type
- Deaths to specific enemy types
- Fastest kill times per enemy
- Perfect dodges vs specific enemies

**Future Use Cases**:
- "Dragon Slayer" title (kill 10 dragons)
- "Goblin Hunter" title (kill 100 goblins)
- Enemy-specific achievement tracking
- Advanced combat analytics

**Estimated Effort**: 4-6 hours
**Dependencies**: StatTracker foundation (complete)
```

---

## üìã MASTER TODO LIST (Priority Order)

### PHASE 1: Complete StatTracker Integration

#### P1.1: Skill Usage Tracking
- [ ] Read SkillManager.activate_skill() implementation
- [ ] Identify where to insert tracking call
- [ ] Extract skill category from skill definition
- [ ] Extract value delivered from effect execution context
- [ ] Implement stat_tracker.record_skill_used() call
- [ ] Test with multiple skill types (combat/gathering/crafting/utility)
- [ ] Verify mana costs tracked correctly
- [ ] Commit: "feat: Add skill usage tracking to StatTracker"

#### P1.2: Item Tracking
- [ ] Read Inventory.add_item() implementation
- [ ] Read Inventory.remove_item() implementation
- [ ] Read Inventory.consume_from_inventory() implementation
- [ ] Add item_source parameter to add_item() (optional, default None)
- [ ] Implement stat_tracker.record_item_collected() call
- [ ] Implement stat_tracker.record_item_consumed() call for consumables
- [ ] Handle first-time discovery (check encyclopedia)
- [ ] Handle rarity tracking (get from MaterialDatabase/EquipmentDatabase)
- [ ] Update all add_item() call sites with source context
- [ ] Test item collection from gathering, crafting, combat
- [ ] Commit: "feat: Add item tracking to Inventory system"

#### P1.3: Time Tracking
- [ ] Read game_engine.update() main loop
- [ ] Identify delta time variable
- [ ] Implement stat_tracker.update_playtime(dt) call
- [ ] Track current activity (gathering/crafting/combat/idle)
- [ ] Update time_spent_* fields based on activity
- [ ] Test session time accumulation
- [ ] Test longest session tracking
- [ ] Commit: "feat: Add time tracking to game loop"

#### P1.4: Distance Tracking
- [ ] Read Character.move() implementation
- [ ] Calculate distance from dx/dy
- [ ] Implement stat_tracker.record_movement() call
- [ ] Track sprint state (is_sprinting flag)
- [ ] Track encumbered state (weight > capacity)
- [ ] Get current chunk coordinates from world system
- [ ] Track unique chunks visited
- [ ] Test distance accumulation
- [ ] Test chunk discovery
- [ ] Commit: "feat: Add distance tracking to character movement"

### PHASE 2: Update JSON Files

#### P2.1: Update titles-1.JSON
- [ ] Read current titles-1.JSON structure
- [ ] Identify titles with complex requirements:
  - [ ] Apprentice titles (fireOresMined, alloysCreated)
  - [ ] Journeyman titles (materialsRefined)
  - [ ] Expert titles (criticalHits, perfectDodges)
  - [ ] Master titles (perfectCrafts, legendaryItemsCreated)
  - [ ] Hidden titles (consecutiveFirstTryBonuses, rareDropsFound)
- [ ] For each complex title, add "conditions" array
- [ ] Map legacy requirements to condition types:
  - [ ] activities ‚Üí ActivityCondition or StatTrackerCondition
  - [ ] characterLevel ‚Üí (keep legacy field, already supported)
  - [ ] stats ‚Üí (keep legacy field, already supported)
  - [ ] Complex stats ‚Üí StatTrackerCondition
- [ ] Validate JSON syntax
- [ ] Test loading with TitleDatabase
- [ ] Commit: "data: Update titles-1.JSON with tag-driven conditions"

#### P2.2: Update skill-unlocks.JSON
- [ ] Read current skill-unlocks.JSON structure
- [ ] Identify all unlock methods:
  - [ ] automatic (level-based)
  - [ ] quest_reward (quest completion)
  - [ ] milestone_unlock (activity + stats)
  - [ ] title_unlock (prerequisite title)
  - [ ] npc_purchase (level + stats + gold)
- [ ] For each skill unlock, add "conditions" array
- [ ] Map activityMilestones to StatTrackerCondition:
  - [ ] craft_count ‚Üí crafting_by_discipline.{discipline}.total_crafts
  - [ ] kill_count ‚Üí combat_kills.total_kills
  - [ ] gather_count ‚Üí gathering_totals (aggregate)
- [ ] Validate JSON syntax
- [ ] Commit: "data: Update skill-unlocks.JSON with tag-driven conditions"

### PHASE 3: Skill Unlock System

#### P3.1: Create SkillUnlock Model
- [ ] Create data/models/skill_unlocks.py
- [ ] Define SkillUnlock dataclass
- [ ] Include unlock_id, skill_id, unlock_method
- [ ] Include requirements (UnlockRequirements)
- [ ] Include trigger info (type, value, message)
- [ ] Include cost (gold, materials)
- [ ] Add to_dict() for serialization
- [ ] Commit: "feat: Create SkillUnlock data model"

#### P3.2: Create SkillUnlockDatabase
- [ ] Create data/databases/skill_unlock_db.py
- [ ] Implement singleton pattern
- [ ] Implement load_from_file() with ConditionFactory
- [ ] Parse all unlock methods
- [ ] Parse trigger information
- [ ] Parse costs
- [ ] Create index by trigger_type for efficiency
- [ ] Create lookup by skill_id
- [ ] Add to main.py initialization
- [ ] Test loading skill-unlocks.JSON
- [ ] Commit: "feat: Create SkillUnlockDatabase"

#### P3.3: Create SkillUnlockSystem
- [ ] Create systems/skill_unlock_system.py
- [ ] Implement unlocked_skills set (persisted in save)
- [ ] Implement check_for_unlocks(character, trigger_type, trigger_value)
- [ ] Implement is_skill_unlocked(skill_id)
- [ ] Implement unlock_skill(skill_id)
- [ ] Add to Character.__init__()
- [ ] Add serialization to save_manager.py
- [ ] Add deserialization to Character.restore_from_save()
- [ ] Commit: "feat: Create SkillUnlockSystem"

#### P3.4: Integrate Unlock Triggers
- [ ] **Level Up Trigger**:
  - [ ] Add to LevelingSystem.add_exp() after level up
  - [ ] Call skill_unlocks.check_for_unlocks(character, "level_up", new_level)
  - [ ] Emit notifications for newly unlocked skills
- [ ] **Activity Threshold Trigger**:
  - [ ] Add to Character.activities.record_activity() after recording
  - [ ] Call skill_unlocks.check_for_unlocks(character, "activity_threshold", count)
  - [ ] Check both old activity count and new StatTracker values
- [ ] **Title Earned Trigger**:
  - [ ] Add to TitleSystem after earning title
  - [ ] Call skill_unlocks.check_for_unlocks(character, "title_earned", title_id)
  - [ ] Emit notifications
- [ ] **Quest Complete Trigger**:
  - [ ] Add to QuestSystem.complete_quest() after completion
  - [ ] Call skill_unlocks.check_for_unlocks(character, "quest_complete", quest_id)
  - [ ] Emit notifications
- [ ] Commit: "feat: Integrate skill unlock triggers"

#### P3.5: Update SkillManager
- [ ] Read SkillManager.can_learn_skill() implementation
- [ ] Add unlock check: if not character.skill_unlocks.is_skill_unlocked(skill_id): return False, "Skill not unlocked yet"
- [ ] Preserve skip_checks parameter for debug mode
- [ ] Update learn_skill() to remove from unlocked set when learned
- [ ] Test with various unlock conditions
- [ ] Commit: "feat: Integrate unlock system with SkillManager"

#### P3.6: Preserve Debug Mode
- [ ] Verify F2 debug (learn all skills) still works
- [ ] Ensure skip_checks=True bypasses unlock requirements
- [ ] Test toggle on/off multiple times
- [ ] Ensure original skills restored on disable
- [ ] Commit: "test: Verify debug mode compatibility"

### PHASE 4: Testing & Documentation

#### P4.1: Backward Compatibility Testing
- [ ] Create old save file (manually or from backup)
- [ ] Load old save ‚Üí verify no crashes
- [ ] Verify fresh StatTracker initialized
- [ ] Verify fresh SkillUnlockSystem initialized
- [ ] Play for 5 minutes ‚Üí save ‚Üí verify new format
- [ ] Load new format save ‚Üí verify all data preserved
- [ ] Document test results
- [ ] Commit: "test: Verify backward compatibility"

#### P4.2: In-Game Testing
- [ ] **Gathering Tests**:
  - [ ] Mine 100 ores, verify title unlock
  - [ ] Check StatTracker.resources_gathered values
  - [ ] Verify tools_repaired increments
- [ ] **Crafting Tests**:
  - [ ] Craft 10 smithing items, verify skill unlock
  - [ ] Get perfect craft, verify perfectCrafts increments
  - [ ] Check StatTracker.crafting_by_discipline values
- [ ] **Combat Tests**:
  - [ ] Kill 50 enemies, verify title unlock
  - [ ] Get critical hit, verify combat_actions.critical_hits
  - [ ] Check StatTracker.combat_damage values
- [ ] **Skill Tests**:
  - [ ] Use skill 10 times, verify skills_used[id].times_used
  - [ ] Reach unlock conditions, verify skill becomes available
  - [ ] Learn unlocked skill
- [ ] **Save/Load Tests**:
  - [ ] Save mid-session ‚Üí load ‚Üí verify all stats
  - [ ] Verify session_count increments
  - [ ] Verify playtime accumulates
- [ ] Document all test results
- [ ] Commit: "test: Complete in-game testing checklist"

#### P4.3: Create Test Suite
- [ ] Create tests/test_stat_tracker.py
- [ ] Test StatEntry recording
- [ ] Test CraftingEntry success/failure rates
- [ ] Test SkillStatEntry averaging
- [ ] Test serialization round-trip
- [ ] Create tests/test_unlock_conditions.py
- [ ] Test each condition type
- [ ] Test UnlockRequirements composite logic
- [ ] Test ConditionFactory JSON parsing
- [ ] Test legacy format compatibility
- [ ] Run all tests, ensure 100% pass
- [ ] Commit: "test: Add comprehensive test suite"

#### P4.4: Documentation
- [ ] Create docs/STAT_TRACKING_SYSTEM.md
  - [ ] Architecture overview
  - [ ] Stat categories reference
  - [ ] Integration guide
  - [ ] Example use cases
- [ ] Create docs/UNLOCK_SYSTEM_FOR_LLM.md
  - [ ] JSON structure examples
  - [ ] Condition type reference
  - [ ] How to add new titles
  - [ ] How to add new skill unlocks
  - [ ] Tag-driven design philosophy
- [ ] Update CLAUDE.md with new systems
- [ ] Commit: "docs: Add stat tracking and unlock system documentation"

#### P4.5: Update Issue Tracker
- [ ] Open MASTER_ISSUE_TRACKER.md
- [ ] Add "DEFERRED FEATURES" section
- [ ] Document deferred enemy tracking with rationale
- [ ] List future use cases
- [ ] Estimate effort
- [ ] Commit: "docs: Add deferred enemy tracking to issue tracker"

---

## üîç QUALITY CHECKPOINTS

After each phase, verify:
- [ ] All code follows existing patterns and conventions
- [ ] No hardcoded values (use Config or JSON)
- [ ] Proper error handling and logging
- [ ] Type hints where appropriate
- [ ] Comments for complex logic
- [ ] No performance degradation
- [ ] Debug modes still functional
- [ ] Backward compatibility maintained
- [ ] Git commits are atomic and well-described

---

## üìù NOTES & CONSIDERATIONS

### Integration Points Identified
1. **SkillManager.activate_skill()** - Returns effect context with damage/value
2. **Inventory.add_item()** - Called from gathering, crafting, combat
3. **game_engine.update()** - Main loop with dt available
4. **Character.move()** - Movement with dx, dy parameters
5. **LevelingSystem.add_exp()** - Returns bool if leveled up
6. **TitleSystem.check_for_title()** - Already updated, returns earned title
7. **QuestSystem.complete_quest()** - Handles quest rewards

### Critical Decisions
- **Item Source Tracking**: Add optional source parameter to add_item() rather than complex context tracking
- **Activity Context**: Track current activity in game state (gathering/crafting/combat/idle)
- **Chunk Tracking**: Store as list for serialization, convert to set at runtime
- **Skill Unlock State**: Separate "unlocked" from "learned" - unlocked makes available, learned adds to known_skills
- **Debug Mode**: Preserve skip_checks parameter throughout to maintain F2/F3 functionality

### Potential Issues & Mitigations
1. **Performance**: StatTracker updates in hot paths (movement, combat)
   - Mitigation: Keep tracking calls simple, no complex calculations
2. **Double Counting**: Items added from multiple sources
   - Mitigation: Add source context to distinguish collection vs crafting
3. **JSON Compatibility**: Old titles/skills with legacy format
   - Mitigation: ConditionFactory handles both legacy and new formats
4. **Save Bloat**: 1000+ stats per save file
   - Mitigation: JSON compression, only serialize non-zero values
5. **Unlock Trigger Spam**: Checking unlocks too frequently
   - Mitigation: Only check on specific trigger events, not every frame

---

## üéØ SUCCESS CRITERIA

‚úÖ **Phase 1 Complete When**:
- All StatTracker integration points implemented
- Skills tracked correctly
- Items tracked with rarity and discovery
- Time accumulates properly
- Distance and chunks tracked
- All changes committed with clear messages

‚úÖ **Phase 2 Complete When**:
- titles-1.JSON uses new condition format
- skill-unlocks.JSON uses new condition format
- All complex requirements use StatTrackerCondition
- JSONs load without errors
- Legacy format still supported

‚úÖ **Phase 3 Complete When**:
- SkillUnlock model created
- SkillUnlockDatabase loads correctly
- SkillUnlockSystem manages unlock state
- All triggers integrated
- Skills unlock based on conditions
- Debug mode (F2) still works
- Save/load preserves unlock state

‚úÖ **Phase 4 Complete When**:
- Backward compatibility verified
- All in-game tests pass
- Test suite created and passing
- Documentation complete and accurate
- Issue tracker updated

‚úÖ **Overall Success**:
- Titles unlock based on comprehensive stats
- Skills unlock based on comprehensive stats
- LLMs can add new titles/skills via JSON only
- Debug modes functional
- No regressions
- High code quality maintained
- System is modular and extensible
